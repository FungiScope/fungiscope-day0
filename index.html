t<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>FungiScope® Day Counter</title>
<style>
  :root{--bg:#f4f6fb;--card:#ffffff;--muted:#5b677a;--text:#111827;--accent:#2a5dff;--accent-2:#12b981;--line:#d6dae5;--danger:#e11d48}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text)}
  .container{max-width:1100px;margin:0 auto;padding:28px}
  .card{background:var(--card);border:1px solid var(--line);box-shadow:0 10px 24px rgba(17,24,39,.08);border-radius:14px;padding:22px}
  h1{font-size:clamp(22px,3vw,30px);margin:0 0 6px}
  p.sub{margin:0 0 14px;color:var(--muted)}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:end}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

  /* Inputs */
  input[type="date"], input[type="text"], input[type="number"], select{background:#fff;color:var(--text);border:1px solid #9aa4b2;border-radius:10px;padding:10px 12px;outline:none;min-height:42px;font-size:14px}
  input[type="date"]:focus, input[type="text"]:focus, input[type="number"]:focus, select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(42,93,255,.18)}
  input[type="date"]::-webkit-calendar-picker-indicator{filter:none;opacity:1;cursor:pointer;background-color:#fff;border-radius:4px;padding:2px}
  input[type="date"]::-webkit-datetime-edit{color:var(--text)}
  input[type="date"]::-webkit-datetime-edit-text{color:#6b7280}
  input[type="date"]{background-image:none}

  /* Highlight Day 0 input only */
  #day0 {background: #e6ffed ; /* soft green */}
  #day0::-webkit-datetime-edit {background-color: #e6ffed ; }
  #day0::-webkit-calendar-picker-indicator {background-color: #e6ffed ; }
  #day0:focus {border-color: #e6ffed ; box-shadow: 0 0 0 3px rgba(245,158,11,.25);}

  /* Highlight Day 0 date picker (Chrome/Edge/Safari robust) */
#day0 {
  background-color: #e6ffed  !important;   /* base */
  background-clip: padding-box;
}

/* The editable part inside the date input */
#day0::-webkit-datetime-edit,
#day0::-webkit-datetime-edit-fields-wrapper,
#day0::-webkit-datetime-edit-text,
#day0::-webkit-datetime-edit-year-field,
#day0::-webkit-datetime-edit-month-field,
#day0::-webkit-datetime-edit-day-field {
  background-color: #e6ffed  !important;
}

  
/* Calendar icon chip on the right */
#day0::-webkit-calendar-picker-indicator {
  background-color: #e6ffed  !important;
  border-radius: 4px;
}

/* Optional: focus styling to match the green theme */
#day0:focus {
  border-color: #e6ffed ;
  box-shadow: 0 0 0 3px rgba(245,158,11,.25);
}

  .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;transition:transform .05s ease, box-shadow .2s}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--accent);color:#fff;box-shadow:0 6px 16px rgba(42,93,255,.28)}
  .btn-ghost{background:#fff;border:1px solid var(--line);color:var(--text)}
  .btn-danger{background:var(--danger);color:#fff}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}

  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
  thead th{position:sticky;top:0;background:#f9fafc;z-index:1}
  th, td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
  tr:hover td{background:#f3f6ff}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  .col-6{grid-column:span 6}
  .col-12{grid-column:span 12}
  @media (max-width:900px){.col-6{grid-column:span 12}}
  .help{font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace, monospace;border:1px solid var(--line);padding:0 6px;border-radius:6px}
  .pill{display:inline-flex; justify-content: center;width: 120px; align-items: center;padding:6px 14px;border-radius:12px;border:2px solid var(--line);font-size:15px;color:#374151;background:#fff3b0 !important;}
  .footer{margin-top:16px;font-size:12px;color:var(--muted)}
  .sep{height:1px;background:var(--line);margin:16px 0}

  dialog{border:1px solid var(--line);border-radius:12px;padding:18px;max-width:520px}
  dialog::backdrop{background:rgba(0,0,0,.25)}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1 id="header">FungiScope® Day Counter</h1>
    <p class="sub" id="sub"></p>

    <div class="grid">
      <div class="col-6">
        <label for="day0" id="lblDay0"></label>
        <input id="day0" type="date"/>
        <div class="help" id="helpDay0"></div>
      </div>
      <div class="col-6">
        <label for="localeSel">Language</label>
        <select id="localeSel">
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="es">Español</option>
          <option value="it">Italiano</option>
          <option value="ru">Русский</option>
        </select>
      </div>
    </div>

    <!-- Light grey info box with red text -->
    <div id="noticeBox" style="margin:18px 0; padding:12px 16px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:10px; font-size:15px; line-height:1.5; color:#b91c1c;"></div>

    <div class="sep"></div>

    <div class="row">
      <div>
        <label id="lblNewEvent"></label>
        <input id="labelInput" placeholder="" type="text"/>
      </div>
      <div>
        <label id="lblEventDate"></label>
        <input id="dateInput" type="date"/>
      </div>
      <button class="btn btn-primary" id="addRowBtn" type="button"></button>
      <button class="btn btn-ghost" id="addDayBtn" type="button"></button>
    </div>

    <table id="eventsTable">
      <thead>
        <tr>
          <th>#</th>
          <th id="thLabel"></th>
          <th id="thDate"></th>
          <th id="thRel"></th>
          <th id="thAct"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="sep"></div>

    <div class="toolbar">
      <button class="btn btn-ghost" id="copyTable" type="button"></button>
      <button class="btn btn-ghost" id="exportCSV" type="button"></button>
      <button class="btn btn-ghost" id="copyLink" type="button"></button>
      <button class="btn btn-danger" id="clearAll" type="button"></button>
    </div>

    <div class="footer" id="footerNote"></div>
  </div>
</div>

<dialog id="fromDayDialog">
  <form method="dialog">
    <h3 id="dlgTitle" style="margin:0 0 6px"></h3>
    <p class="muted" id="dlgSub" style="margin:0 0 12px"></p>
    <div class="row" style="margin-bottom:12px">
      <div>
        <label id="dlgLbl"></label>
        <input id="fromDayLabel" type="text"/>
      </div>
      <div>
        <label id="dlgRel"></label>
        <input id="fromDayValue" step="1" type="number"/>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" id="dlgCancel" value="cancel"></button>
      <button class="btn btn-primary" id="dlgOk" value="ok"></button>
    </div>
  </form>
</dialog>

<template id="rowTpl">
  <tr>
    <td class="idx"></td>
    <td><input class="lbl" placeholder="" type="text"/></td>
    <td><input class="dt" type="date"/></td>
    <td class="rd"><span class="pill">Day <strong>0</strong></span></td>
    <td>
      <button class="btn btn-ghost act-up" title="Move up" type="button">↑</button>
      <button class="btn btn-ghost act-down" title="Move down" type="button">↓</button>
      <button class="btn btn-ghost act-copy" title="Copy" type="button">Copy</button>
      <button class="btn btn-ghost act-dup" title="Duplicate" type="button">Duplicate</button>
      <button class="btn btn-danger act-del" title="Delete" type="button">Delete</button>
    </td>
  </tr>
</template>

<script>
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => [...el.querySelectorAll(s)];

  const day0El = $('#day0');
  const tableBody = $('#eventsTable tbody');
  const labelInput = $('#labelInput');
  const dateInput = $('#dateInput');
  const addRowBtn = $('#addRowBtn');
  const addDayBtn = $('#addDayBtn');
  const copyTableBtn = $('#copyTable');
  const exportCSVBtn = $('#exportCSV');
  const copyLinkBtn = $('#copyLink');
  const clearAllBtn = $('#clearAll');
  const localeSel = $('#localeSel');

  const dialog = $('#fromDayDialog');
  const fromDayLabel = $('#fromDayLabel');
  const fromDayValue = $('#fromDayValue');

  // i18n dictionary (EN, DE, ES, IT, RU)
  const L = {
    en:{header:"FungiScope® Day Counter",alertSetDay0:"Please set Day 0 first.",sub:"Convert calendar dates to relative study days and vice versa. No data is uploaded; everything runs locally in your browser.",lblDay0:"Day 0 (earliest confirmation of IC/C)",helpDay0:"Tip: Share a link with pre-filled Day 0.",lblNewEvent:"New event label",lblEventDate:"Event date",add:"Add",fromRel:"From relative day…",thLabel:"Label",thDate:"Date",thRel:"Relative day",thAct:"Actions",copySummary:"Copy summary",exportCSV:"Export CSV",copyLink:"Copy link with Day 0",clearAll:"Clear all",footer:"ℹ️ <strong>Day 0</strong> is defined as the date of the earliest laboratory result indicating <em>Candida</em>/yeast positivity reported to the physician. This can be a preliminary lab call (e.g., yeast seen under the microscope) or a final culture result that provides the physician with evidence to start antifungal treatment. If the patient dies before any report is given, the <strong>date of death</strong> is considered Day 0. <strong>Important</strong>: The sample collection date is <strong>not</strong> Day 0.",notice:"ℹ️ <strong>Day 0</strong> is the date of the earliest <em>Candida</em> report from the laboratory. This does not need to be a final species identification; it may also be a preliminary lab call (e.g., “yeast seen under the microscope”), providing the physician with evidence to start antifungal treatment.<br><br>If the patient dies before any report is issued, the date of death is considered Day 0. <strong>Important:</strong> the sample collection date is <u>not</u> Day 0.",phLabel:"e.g., Blood sample collected",dlgTitle:"Compute calendar date from relative day",dlgSub:"Enter a label and a relative day (e.g., -3 or +14). We'll add a row with the computed calendar date.",dlgLbl:"Label",dlgRel:"Relative day",dlgCancel:"Cancel",dlgOk:"Add",copyRow:"Copied!"},
    de:{header:"FungiScope® Tageszähler",alertSetDay0:"Bitte bestimmen Sie zuerst Tag 0.",sub:"Kalenderdaten in relative Studientage umrechnen und umgekehrt. Es werden keine Daten hochgeladen; alles läuft lokal in Ihrem Browser.",lblDay0:"Tag 0 (früheste Bestätigung von IC/C)",helpDay0:"Hinweis: Link mit vorausgefülltem Tag 0 teilen.",lblNewEvent:"Neues Ereignis – Bezeichnung",lblEventDate:"Ereignisdatum",add:"Hinzufügen",fromRel:"Aus relativem Tag…",thLabel:"Bezeichnung",thDate:"Datum",thRel:"Relativer Tag",thAct:"Aktionen",copySummary:"Zusammenfassung kopieren",exportCSV:"Als CSV exportieren",copyLink:"Link mit Tag 0 kopieren",clearAll:"Alles löschen",footer:"ℹ️ Tag 0 ist der Tag, an dem der behandelnde Arzt erstmals über eine Candida/Hefepositivität informiert wird. Dies kann ein vorläufiger Laborruf (z. B. Hefen im Mikroskop) oder ein endgültiges Kulturergebnis sein. Wenn der Patient vor jeglicher Mitteilung verstirbt, ist das <strong>Sterbedatum</strong> Tag 0. Wichtig: Das Probendatum ist nicht Tag 0.",notice:"ℹ️ <strong>Tag 0</strong> ist das Datum des frühesten <em>Candida</em>-Berichts aus dem Labor. Dies muss keine endgültige Speziesidentifikation sein; es kann auch ein vorläufiger Laboranruf sein (z. B. „Hefe im Mikroskop gesehen“), der dem Arzt die Evidenz liefert, eine antimykotische Therapie zu beginnen.<br><br>Wenn der Patient vor jeglicher Mitteilung verstirbt, gilt das Sterbedatum als Tag 0. <strong>Wichtig:</strong> Das Probendatum ist <u>nicht</u> Tag 0.",phLabel:"z. B. Blutprobe entnommen",dlgTitle:"Kalenderdatum aus relativem Tag berechnen",dlgSub:"Bezeichnung und relativen Tag eingeben (z. B. −3 oder +14).",dlgLbl:"Bezeichnung",dlgRel:"Relativer Tag",dlgCancel:"Abbrechen",dlgOk:"Hinzufügen",copyRow:"Kopiert!"},
    es:{header:"FungiScope® Contador de Días",alertSetDay0:"Por favor, establezca primero el Día 0.",sub:"Convierte las fechas del calendario en días relativos del estudio y viceversa. No se cargan datos; todo se ejecuta localmente en su navegador.",lblDay0:"Día 0 (confirmación más temprana de IC/C)",helpDay0:"Consejo: comparte un enlace con Día 0 prellenado.",lblNewEvent:"Nueva etiqueta de evento",lblEventDate:"Fecha del evento",add:"Añadir",fromRel:"Desde día relativo…",thLabel:"Etiqueta",thDate:"Fecha",thRel:"Día relativo",thAct:"Acciones",copySummary:"Copiar resumen",exportCSV:"Exportar CSV",copyLink:"Copiar enlace con Día 0",clearAll:"Borrar todo",footer:"ℹ️ El Día 0 es la fecha en que el médico es informado por primera vez de la positividad de Candida/levadura. Puede ser una llamada preliminar de laboratorio (p. ej., levaduras observadas al microscopio) o un resultado final de cultivo. Si el paciente muere antes de cualquier informe, la fecha de fallecimiento es el Día 0. Importante: la fecha de recogida de la muestra no es el Día 0.",notice:"ℹ️ <strong>Día 0</strong> es la fecha del informe más temprano de <em>Candida</em> del laboratorio. No tiene que ser una identificación final de especie; también puede ser una llamada preliminar del laboratorio (p. ej., «levaduras observadas al microscopio»), que proporciona al médico evidencia para iniciar el tratamiento antifúngico.<br><br>Si el paciente fallece antes de que se emita algún informe, la fecha de defunción se considera Día 0. <strong>Importante:</strong> la fecha de toma de la muestra <u>no</u> es el Día 0.",phLabel:"p. ej., Muestra de sangre tomada",dlgTitle:"Calcular fecha desde día relativo",dlgSub:"Introduce una etiqueta y un día relativo (p. ej., −3 o +14).",dlgLbl:"Etiqueta",dlgRel:"Día relativo",dlgCancel:"Cancelar",dlgOk:"Añadir",copyRow:"¡Copiado!"},
    it:{header:"FungiScope® Contatore Giorni",alertSetDay0:"Imposta prima il Giorno 0, per favore.",sub:"Converti rapidamente le date del calendario in giorni relativi dello studio e viceversa. Nessun dato viene caricato; tutto avviene localmente nel browser.",lblDay0:"Giorno 0 (prima conferma di IC/C)",helpDay0:"Suggerimento: condividi un link con il Giorno 0 precompilato.",lblNewEvent:"Nuova etichetta evento",lblEventDate:"Data evento",add:"Aggiungi",fromRel:"Da giorno relativo…",thLabel:"Etichetta",thDate:"Data",thRel:"Giorno relativo",thAct:"Azioni",copySummary:"Copia riepilogo",exportCSV:"Esporta CSV",copyLink:"Copia link con Giorno 0",clearAll:"Cancella tutto",footer:"ℹ️ Il Giorno 0 è la data in cui il medico viene informato per la prima volta della positività a Candida/lievito. Può essere una chiamata preliminare del laboratorio (es. lieviti osservati al microscopio) o un risultato finale della coltura. Se il paziente muore prima di qualsiasi comunicazione, la data del decesso è il Giorno 0. Importante: la data di raccolta del campione non è il Giorno 0.",notice:"ℹ️ <strong>Giorno 0</strong> è la data del primo referto di laboratorio su <em>Candida</em>. Non deve essere un’identificazione finale della specie; può anche essere una chiamata preliminare del laboratorio (es. «lievito osservato al microscopio»), che fornisce al medico le prove per iniziare la terapia antifungina.<br><br>Se il paziente muore prima che venga emesso qualsiasi referto, la data del decesso è considerata Giorno 0. <strong>Importante:</strong> la data di prelievo del campione <u>non</u> è il Giorno 0.",phLabel:"es.: Prelievo di sangue eseguito",dlgTitle:"Calcola data da giorno relativo",dlgSub:"Inserisci un’etichetta e un giorno relativo (es. −3 o +14).",dlgLbl:"Etichetta",dlgRel:"Giorno relativo",dlgCancel:"Annulla",dlgOk:"Aggiungi",copyRow:"Copiato!"},
    ru:{header:"FungiScope® Счётчик Дней",alertSetDay0:"Пожалуйста, сначала установите День 0.",sub:"Быстро конвертируйте календарные даты в относительные дни исследования и обратно. Данные не загружаются; всё работает локально в вашем браузере.",lblDay0:"День 0 (первое подтверждение IC/C)",helpDay0:"Совет: поделитесь ссылкой с предзаполненным Днём 0.",lblNewEvent:"Метка события",lblEventDate:"Дата события",add:"Добавить",fromRel:"Из относительного дня…",thLabel:"Метка",thDate:"Дата",thRel:"Относительный день",thAct:"Действия",copySummary:"Скопировать сводку",exportCSV:"Экспорт CSV",copyLink:"Ссылка с Днём 0",clearAll:"Очистить всё",footer:"ℹ️ День 0 — это дата, когда врач впервые информируется о положительном результате на Candida/дрожжи. Это может быть предварительный звонок из лаборатории (напр., обнаружение дрожжей под микроскопом) или окончательный результат посева. Если пациент умирает до любого сообщения, датой смерти считается День 0. Важно: дата взятия образца не является Днём 0.",notice:"ℹ️ <strong>День 0</strong> — это дата самого раннего лабораторного отчёта о <em>Candida</em>. Это не обязательно окончательная идентификация вида; это может быть и предварительный звонок из лаборатории (напр., «дрожжи под микроскопом»), дающий врачу основания начать противогрибковую терапию.<br><br>Если пациент умирает до какого-либо сообщения, датой смерти считается День 0. <strong>Важно:</strong> дата взятия образца — это <u>не</u> День 0.",phLabel:"напр., Взятие образца крови",dlgTitle:"Вычислить дату из относительного дня",dlgSub:"Введите метку и относительный день (напр., −3 или +14).",dlgLbl:"Метка",dlgRel:"Относительный день",dlgCancel:"Отмена",dlgOk:"Добавить",copyRow:"Скопировано!"}
  };

  function i18n(){ return L[localeSel.value] || L.en; }

  function applyLocale(){
    const t = i18n();
    $('#header').textContent = t.header;
    $('#sub').textContent = t.sub;
    $('#lblDay0').textContent = t.lblDay0;
    $('#helpDay0').textContent = t.helpDay0;
    $('#lblNewEvent').textContent = t.lblNewEvent;
    $('#lblEventDate').textContent = t.lblEventDate;
    addRowBtn.textContent = t.add;
    addDayBtn.textContent = t.fromRel;
    $('#thLabel').textContent = t.thLabel;
    $('#thDate').textContent = t.thDate;
    $('#thRel').textContent = t.thRel;
    $('#thAct').textContent = t.thAct;
    copyTableBtn.textContent = t.copySummary;
    exportCSVBtn.textContent = t.exportCSV;
    copyLinkBtn.textContent = t.copyLink;
    clearAllBtn.textContent = t.clearAll;
    $('#footerNote').innerHTML = t.footer;
    const nb = document.getElementById('noticeBox'); 
    if (nb && t.notice) { nb.innerHTML = t.notice; }
    labelInput.placeholder = t.phLabel;
    $$('#eventsTable .lbl').forEach(el => el.placeholder = t.phLabel);
    $('#dlgTitle').textContent = t.dlgTitle;
    $('#dlgSub').textContent = t.dlgSub;
    $('#dlgLbl').textContent = t.dlgLbl;
    $('#dlgRel').textContent = t.dlgRel;
    $('#dlgCancel').textContent = t.dlgCancel;
    $('#dlgOk').textContent = t.dlgOk;
    // Recompute rows so the "Day" label stays correct in the selected language (number only; label shown in pill stays "Day")
    $$('#eventsTable tbody tr').forEach(computeRow);
  }

  localeSel.addEventListener('change', ()=>{
    const url = new URL(location.href);
    url.searchParams.set('lang', localeSel.value);
    history.replaceState(null,'',url);
    applyLocale();
  });

  // Date helpers
  const toDateOnly = d => { if(!d) return null; const x=new Date(d); return new Date(x.getFullYear(),x.getMonth(),x.getDate()); };
  const fmtISO = d => { if(!d) return ''; const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; };
  const diffDays = (a,b) => Math.round((toDateOnly(b)-toDateOnly(a))/86400000);
  const addDays = (d,n) => { const b=toDateOnly(d); const r=new Date(b); r.setDate(r.getDate()+Number(n)); return r; };

function setMaxTodayForDay0() {
  const todayStr = fmtISO(new Date());
  
  day0El.max = todayStr;                 // prevent picking a future date in the picker
  if (day0El.value && day0El.value > todayStr) {
    day0El.value = '';             // clamp back to empty if a future date was set
  }
}
 
  setMaxTodayForDay0();
  
  function renumber(){ $$('#eventsTable tbody tr').forEach((tr,i)=>$('.idx',tr).textContent=i+1); }

function moveRow(tr, dir) {
  const sib = dir < 0 ? tr.previousElementSibling : tr.nextElementSibling;
  if (!sib) return; // first row can't move up, last row can't move down
  if (dir < 0) {
    // move up: put current row before the previous one
    sib.before(tr);
  } else {
    // move down: put current row after the next one
    sib.after(tr);
  }
  renumber();
}
  
function computeRow(tr){
  const d0 = day0El.valueAsDate, dt = $('.dt',tr).valueAsDate, cell = $('.rd',tr);
  if(!d0 || !dt){ cell.innerHTML = '<span class="muted">—</span>'; tr.dataset.rel=''; return; }
  const rel = diffDays(d0, dt);
  // Show only the number: positives like "5", negatives like "-3", zero "0"
  cell.innerHTML = `<span class="pill"><strong>${rel}</strong></span>`;
  tr.dataset.rel = rel;
}

  function addRow(lbl='', dateStr=''){
    const tpl=$('#rowTpl').content.cloneNode(true); const tr=tpl.querySelector('tr');
    $('.lbl',tr).value=lbl; $('.lbl',tr).placeholder=i18n().phLabel; $('.dt',tr).value=dateStr;
    $('.dt',tr).addEventListener('input', ()=>computeRow(tr));
    $('.act-del',tr).addEventListener('click', ()=>{ tr.remove(); renumber(); });
    $('.act-dup',tr).addEventListener('click', ()=> addRow($('.lbl',tr).value,$('.dt',tr).value));
    $('.act-copy',tr).addEventListener('click', async()=>{  const rel = tr.dataset.rel ?? '';  if(rel === '') return;  await navigator.clipboard.writeText(String(rel)); const old = $('.act-copy',tr).textContent;  $('.act-copy',tr).textContent = i18n().copyRow;  setTimeout(()=>$('.act-copy',tr).textContent = old, 900);});
    $('.act-up', tr).addEventListener('click', () => moveRow(tr, -1));
    $('.act-down', tr).addEventListener('click', () => moveRow(tr, +1));
    tableBody.appendChild(tr); computeRow(tr); renumber();
  }

  addRowBtn.addEventListener('click', ()=>{
    if(!day0El.value){ alert(i18n().alertSetDay0); day0El.focus(); return; }
    addRow(labelInput.value.trim(), dateInput.value);
    labelInput.value=''; dateInput.value=''; labelInput.focus();
  });

  addDayBtn.addEventListener('click', ()=>{
    if(!day0El.value){ alert(i18n().alertSetDay0); return; }
    applyLocale(); 
    dialog.showModal(); 
    fromDayLabel.value=''; fromDayValue.value='';
    setTimeout(()=>fromDayLabel.focus(), 10);
  });

  dialog.addEventListener('close', ()=>{
    if(dialog.returnValue!=='ok') return;
    const lbl=fromDayLabel.value.trim()||i18n().lblNewEvent;
    const rel=parseInt(fromDayValue.value,10);
    if(Number.isNaN(rel)) return;
    const d=addDays(day0El.valueAsDate,rel);
    addRow(lbl, fmtISO(d));
  });

copyTableBtn.addEventListener('click', async()=>{
  const lines = [day0El.value ? `Day 0: ${day0El.value}` : 'Day 0: —', ''];
  $$('#eventsTable tbody tr').forEach(tr=>{
    const lbl = $('.lbl',tr).value || '—';
    const dt  = $('.dt',tr).value || '—';
    const rel = tr.dataset.rel ?? '—';
    lines.push(`${lbl}\t${dt}\t${rel === '—' ? '—' : rel}`); // just the number
  });
  await navigator.clipboard.writeText(lines.join('\n'));
  alert('Summary copied to clipboard.');
});

  exportCSVBtn.addEventListener('click', ()=>{
    const rows=[[i18n().thLabel,i18n().thDate,i18n().thRel]];
    $$('#eventsTable tbody tr').forEach(tr=>{
      rows.push([$('.lbl',tr).value||'', $('.dt',tr).value||'', tr.dataset.rel??'']);
    });
    const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); 
    const a=document.createElement('a'); 
    a.href=URL.createObjectURL(blob); 
    a.download='fungiscope_day0_timeline.csv'; 
    a.click(); 
    URL.revokeObjectURL(a.href);
  });

  function updateQuery(){ 
    const d0=day0El.value; 
    const url=new URL(location.href); 
    if(d0) url.searchParams.set('day0',d0); else url.searchParams.delete('day0'); 
    history.replaceState(null,'',url); 
  }
  copyLinkBtn.addEventListener('click', async()=>{
    updateQuery(); 
    await navigator.clipboard.writeText(location.href); 
    alert('Link copied.');
  });

  clearAllBtn.addEventListener('click', ()=>{
    if(!confirm('Clear all rows?'))return; 
    tableBody.innerHTML=''; 
    renumber();
  });

day0El.addEventListener('input', ()=>{
  const todayStr = fmtISO(new Date());
  if (day0El.value && day0El.value > todayStr) {
    day0El.value = '';   // reset back to empty (default) if a future date is typed/pasted
  }
  $$('#eventsTable tbody tr').forEach(computeRow); 
  updateQuery();
});

  // Prefill from URL and language
  const params=new URLSearchParams(location.search); 
  const pDay0=params.get('day0'); 
  const pLang=params.get('lang'); 
  if(pDay0) day0El.value=pDay0; 
  if(pLang && L[pLang]) localeSel.value=pLang;

  // Initial render
  applyLocale();
</script>
</body>
</html>


















